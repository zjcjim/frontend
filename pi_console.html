<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Predator</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: url('background.jpg') no-repeat center 35px fixed;
            background-color: #000901;
            background-size: 100% 150%;
        }

        .title {
            color: #ffffff;
            font-size: 48px;
            margin-bottom: 20px;
            font-family: 'Impact', Charcoal, sans-serif;
            text-shadow: 4px 4px #ff0000, -4px -4px #0000ff;
        }

        #videoContainer {
            position: relative;
            width: 60%;
            height: 80%;
            max-width: 1280px;
            max-height: 720px;
            border: 5px solid #ffffff;
            border-radius: 10px;
            overflow: hidden;
        }

        #videoStream {
            display: block;
            width: 100%;
            height: 100%;
        }

        #videoCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #shootButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 24px;
            cursor: pointer;
            background-color: #ff0000;
            color: #ffffff;
            border: none;
            border-radius: 5px;
        }

        #shootButton:active {
            transform: scale(0.95);
            background-color: #d40000;
        }
    </style>
</head>

<body>
    <h1 class="title">Target Tracing</h1>
    <div id="videoContainer">
        <img src="" id="videoStream" alt="Video Stream" />
        <canvas id="videoCanvas" width="1280" height="720"></canvas>
    </div>
    <button id="shootButton">Shoot</button>

    <script>
        const videoStream = document.getElementById('videoStream');
        const videoCanvas = document.getElementById('videoCanvas');
        const ctx = videoCanvas.getContext('2d');
        const shootButton = document.getElementById('shootButton');

        let pi_ip = null;
        let backend_ip = null;

        let currentRect = { x1: 0, y1: 0, x2: 0, y2: 0 };
        let targetRect = { x1: 0, y1: 0, x2: 0, y2: 0 };

        function fetchDeviceIP() {
            fetch('http://124.71.164.229:5000/get_ips')
                .then(response => response.json())
                .then(data => {
                    pi_ip = data['pi'];
                    backend_ip = data['backend'];

                    if (pi_ip) {
                        console.log(`IP address for 'pi': ${pi_ip}`);
                        videoStream.src = 'http://' + pi_ip + ':9000/stream.mjpg';
                    } else {
                        console.log(`'pi' device not found. Retrying...`);
                        setTimeout(fetchDeviceIP, 2000);  // Retry after 2 seconds
                    }

                    if (backend_ip) {
                        console.log(`IP address for 'backend': ${backend_ip}`);
                        startFetchingRectangle();
                    } else {
                        console.log(`'backend' device not found. Retrying...`);
                        setTimeout(fetchDeviceIP, 2000);  // Retry after 2 seconds
                    }
                })
                .catch(error => {
                    console.error('Error fetching IPs:', error);
                    setTimeout(fetchDeviceIP, 2000);  // Retry after 2 seconds
                });
        }

        function startFetchingRectangle() {
            setInterval(() => {
                fetch(`http://${backend_ip}:5000/rectangle`)
                    .then(response => response.json())
                    .then(data => {
                        targetRect.x1 = parseInt(data['rectangle_lt_x']);
                        targetRect.y1 = parseInt(data['rectangle_lt_y']);
                        targetRect.x2 = parseInt(data['rectangle_rb_x']);
                        targetRect.y2 = parseInt(data['rectangle_rb_y']);
                        const targetLost = data['target_lost'] === 'true';

                        if (targetLost) {
                            clearCanvas();
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching rectangle coordinates:', error);
                    });
            }, 100); // 每秒获取一次
        }

        function interpolate(current, target, factor) {
            return current + (target - current) * factor;
        }

        function animate() {
            currentRect.x1 = interpolate(currentRect.x1, targetRect.x1, 0.1);
            currentRect.y1 = interpolate(currentRect.y1, targetRect.y1, 0.1);
            currentRect.x2 = interpolate(currentRect.x2, targetRect.x2, 0.1);
            currentRect.y2 = interpolate(currentRect.y2, targetRect.y2, 0.1);

            clearCanvas();
            drawCrosshairAndCorners(currentRect.x1, currentRect.y1, currentRect.x2, currentRect.y2);

            requestAnimationFrame(animate);
        }

        function drawCrosshairAndCorners(x1, y1, x2, y2) {
            ctx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);

            const centerX = (x1 + x2) / 2;
            const centerY = (y1 + y2) / 2;

            ctx.strokeStyle = '#06f716';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(centerX - 18, centerY);
            ctx.lineTo(centerX + 18, centerY);
            ctx.moveTo(centerX, centerY - 18);
            ctx.lineTo(centerX, centerY + 18);
            ctx.stroke();

            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(x1, y1 + 40);
            ctx.lineTo(x1, y1);
            ctx.lineTo(x1 + 40, y1);
            ctx.moveTo(x2, y1 + 40);
            ctx.lineTo(x2, y1);
            ctx.lineTo(x2 - 40, y1);
            ctx.moveTo(x1, y2 - 40);
            ctx.lineTo(x1, y2);
            ctx.lineTo(x1 + 40, y2);
            ctx.moveTo(x2, y2 - 40);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x2 - 40, y2);
            ctx.stroke();
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
        }

        function sendShootCommand() {
            fetch(`http://${pi_ip}:5000/key`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: 'shoot' })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Shoot command sent:', data);
                })
                .catch(error => {
                    console.error('Error sending shoot command:', error);
                });
        }

        shootButton.addEventListener('click', () => {
            sendShootCommand();
        });

        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                sendShootCommand();
            }
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            fetchDeviceIP();
            animate();
        });
    </script>
</body>

</html>